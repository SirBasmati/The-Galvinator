const Discord = require("discord.js");
const client = new Discord.Client();
const fs = require("fs");
const date = new Date();
const snoowrap = require("snoowrap");
const snoostorm = require("snoostorm");
const config = require("./JSON/config/config.json");
const path = require("path");
const directory = path.dirname(require.main.filename);
console.log(directory);
require("dotenv").config();
console.log(config.prefix);


const JSONFiles = {
    "artwork": directory + "/JSON/artwork.json",
    "brainlet": directory + "/JSON/brainlet.json",
    "copypasta": directory +  "/JSON/copypasta.json",
    "discordmeme": directory + "/JSON/discord memes.json",
    "eightball": directory + "/JSON/eightball.json",
    "fino": directory + "/JSON/fino.json",
    "roast": directory + "/JSON/roast.json",
    "userID": directory + "/JSON/users.json"
};


function JSONManipulation(messageArr, msg) {
    let addCommand = null;
    console.log("===");
    console.log(messageArr);
    console.log(messageArr[0]);
    console.log("===");

    messageArr[0] = messageArr[0].replace("!", "");
    console.log(messageArr);
    

    if (messageArr[0] === "add") {
        addCommand = messageArr.shift();
        console.log("--")
        console.log(addCommand);
        console.log(messageArr);
    }

    try {
        var parsedJSON = JSON.parse(fs.readFileSync(JSONFiles[messageArr[0]]));
    }

    catch (err) {
        return console.log("invalid command - " + err);
    }

    let JSONLength = Object.keys(parsedJSON).length;


    if (addCommand === null) {
        if (typeof messageArr[1] === "undefined" || parseInt(messageArr[1]) > JSONLength || isNaN(messageArr[1]) === true || messageArr[1] === null) {//overwrites old number and replaces it with a number within the jsons reach, these check to make sure we do that
            console.log("reassigning messagearr[1]");
            messageArr[1] = (Math.floor(Math.random() * JSONLength) + 1);
        }
        console.log(messageArr[1]);
        let JSONOutput = parsedJSON[messageArr[1]];
        return JSONOutput;
    }
    else if (addCommand !== null) {
        parsedJSON[JSONLength + 1] = messageArr[1];
        console.log(JSONLength);
        fs.writeFileSync(JSONFiles[messageArr[0]], JSON.stringify(parsedJSON, null, 2));
        if (config.updateChannel === true) {
            console.log("Finding channel");
            console.log(msg.guild.channels.find(channel => channel.name === "#discord-memes"));
        }
        return "Link appended to file at file " + JSONFiles[messageArr[0]] + " at value " + (JSONLength + 1);
    }
}


console.log("Loaded all modules");
try {
    client.on("ready", () => {
        console.log(`Logged in as ${client.user.tag}`);
        client.user.setPresence({ game: { name: "fortnite" }, status: "online" });
    })

    client.on("message", msg => {
        msg = msg.content;
        msg = msg.toLowerCase();
        msgSplit = msg.trim().split(/ +/g); //forms array - removes whitespace + splits at spaces
        msgSplit.length = 3
        if (msg.bot !== true) {
            for (let i = 0; i < msgSplit.length; i++) { //message analysis
                if (msgSplit[i] === "im" || msgSplit[i] === "i'm") {
                    let RNG = Math.floor(Math.random() * config.dadChance) + 1;
                    if (RNG === 1) {
                        let dadQuote = msgSplit.splice(i + 1);
                        dadQuote = dadQuote.join(" ");
                        console.log("Hi " + dadQuote + ", I'm dad!");
                    }
                }
                if (msgSplit[i] === "comedy" || msgSplit[i] === "comedgy") {
                    console.log(config.comedy);
                }
            }
        }

        if (msg.startsWith(config.prefix + "add") || msg.startsWith(config.prefix + "discordmeme")) {
            console.log("gamer time ");
            console.log(JSONManipulation(msgSplit));
        }

    })
    client.login(config.token);
}


catch (err) {
    console.log(err);
}



